{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page d'accueil de l'application</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'instruction/css/preinstruction_dossier.css' %}">
    <link rel="stylesheet" href="{% static 'instruction/css/instruction_dossier.css' %}">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Turf.js -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

</head>

<body>
    {% include 'navbar.html' %}

    <div class="refresh-doss">
        <form method="post" action="{% url 'actualiser_dossier' dossier.numero %}">
            {% csrf_token %}
            <button type="submit" class="refresh-button">
                <img src="{% static 'instruction/img/actualiser.png' %}" alt="Actualiser" class="refresh-icon">
                Actualiser
            </button>
        </form>
    </div>
    
    <div class="page-container">
        
        <!-- Colonne gauche : formulaire -->
        <div class="formulaire">

            <h1>DOSSIER n° {{ dossier.numero }} - {{ dossier.id_demarche.type }}</h1>

            <div class="etat-badge-container">
               <div class="etat-badge-menu-dropdown">
                    <div class="etat-badge-label" id="etapeMenuToggle">
                        {{ etape_actuelle.etape|default:"Non défini" }}
                        <span class="dropdown-arrow">&#9660;</span>
                    </div>

                    <div class="etat-badge-menu-content" id="etapeMenuContent">
                        <form method="post" action="{% url 'changer_etape_dossier' %}">
                            {% csrf_token %}
                            <input type="hidden" name="dossierId" value="{{ dossier.id_ds }}">

                            {% for etape in etapes_possibles %}
                                {% if not etape_actuelle or etape.id != etape_actuelle.id %}
                                    <button type="submit" name="etapeDossierId" value="{{ etape.id }}" class="btn_dropdown_instruction">
                                        {{ etape.etape }}
                                    </button>
                                {% endif %}
                            {% endfor %}
                        </form>
                    </div>
                </div>
            </div>



            <div class="champs">
                {% for champ in champs %}
                    {% if champ.type == 'header' %}
                        <h2>{{ champ.titre }}</h2>

                    {% elif champ.type == 'champ' %}
                        <p><strong>{{ champ.nom }}</strong> : {{ champ.valeur }}</p>

                    {% elif champ.type == 'carte' %}
                        <h2>{{ champ.nom }}</h2>
                        <div class="carte-container">
                            <div class="carte" data-geojson='{{ champ.geojson }}'></div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            
        </div>

        <!-- Colonne droite : navigation -->
        <div class="nav_preinstruction">
            <div class="nav_top">
            
                <div class="form_messagerie">
                    <a href="#">
                        <div class="form_msg_box {% if is_formulaire_active %}active{% endif %}">
                            Formulaire
                        </div>
                    </a>
                    <a href="{% url 'instruction_dossier_messagerie' num_dossier=dossier.numero %}">
                        <div class="form_msg_box {% if is_messagerie_active %}active{% endif %}">
                            Messagerie
                        </div>
                    </a>
                    <a href="{% url 'instruction_dossier_consultation' num_dossier=dossier.numero %}">
                        <div class="form_msg_box {% if is_consultation_active %}active{% endif %}">
                            Consultation
                        </div>
                    </a>
                </div>
                
                
                <!-- Lien dossier à droite -->
                <div class="lien_dossier">
                    <a href="#" onclick="copierChemin('{{ dossier.emplacement }}')">
                        <img src="{% static 'instruction/img/folder.png' %}" alt="Voir le dossier">
                    </a>
                </div>
            </div>

            {% if dossier.id_groupeinstructeur %}
                <div class="groupe-instructeur-info">
                    <h3>Groupe Instructeur : {{ dossier.id_groupeinstructeur.nom }}</h3>
                    <ul class="groupe-instructeur-liste">
                        {% for instructeur in membres_groupe %}
                            {% if instructeur.id in instructeurs_dossier_ids %}
                                <li class="instructeur_du_dossier" title="Instructeur affecté à ce dossier">
                                    {{ instructeur.id_agent_autorisations.nom|upper }} {{ instructeur.id_agent_autorisations.prenom|capfirst }}
                                    <img src="{% static 'instruction/img/instructeur.png' %}" alt="Instructeur du dossier" class="logo_instructeur">
                                </li>
                            {% else %}
                                <li class="pas_instructeur_du_dossier">
                                    {{ instructeur.id_agent_autorisations.nom|upper }} {{ instructeur.id_agent_autorisations.prenom|capfirst }}
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>

                    <form method="post" action="{% url 'changer_groupe_instructeur' %}" class="form_groupe_select" id="form-changer-groupe">
                        {% csrf_token %}
                        <input type="hidden" name="dossierId" value="{{ dossier.id_ds }}">
                        <select name="groupeInstructeurId" id="select-changer-groupe">
                            <option value="" selected disabled hidden>Changer le groupe instructeur</option>
                            {% for groupe in groupes_instructeurs %}
                                {% if not dossier.id_groupeinstructeur or groupe.id != dossier.id_groupeinstructeur.id %}
                                    <option value="{{ groupe.id }}">{{ groupe.nom }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </form>
                </div>
            {% endif %}


            <div class="groupe-instructeur-info notes_instructeurs">
                <h3>Notes de l'instructeur :</h3>

                <form method="post" action="{% url 'sauvegarder_note_dossier' %}" class="form_groupe_select">
                    {% csrf_token %}
                    <input type="hidden" name="dossierId" value="{{ dossier.id_ds }}">
                    <textarea name="note" rows="6" style="resize: vertical;">{{ dossier.note }}</textarea>
                    <button type="submit" class="valider-btn" style="margin-top: 1rem;">Enregistrer</button>
                </form>
            </div>

        </div>
    </div>

    
<!-- 1. Données JSON pour le fond de carte -->
{{ fond_de_carte_data|json_script:"fond-data" }}

<!-- 2. Variables globales accessibles à ton JS -->
<script> window._fondDeCarteData = JSON.parse(document.getElementById("fond-data").textContent);</script>

<!-- 3. Script Leaflet personnalisé -->
<script src="{% static 'instruction/js/preinstruction_map.js' %}"></script>


<!-- Menu déroulant état dossier -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.getElementById("etapeMenuToggle");
    const menuContent = document.getElementById("etapeMenuContent");
    const dropdownWrapper = toggleBtn.closest(".etat-badge-menu-dropdown");

    toggleBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        menuContent.classList.toggle("show");
        dropdownWrapper.classList.toggle("open");
    });

    document.addEventListener("click", function () {
        menuContent.classList.remove("show");
        dropdownWrapper.classList.remove("open");
    });
});
</script>

<!-- POP UP de validation du chagement de groupe instructeur -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const select = document.getElementById("select-changer-groupe");
    const form = document.getElementById("form-changer-groupe");

    select.addEventListener("change", function() {
        const selectedOption = select.options[select.selectedIndex].text;
        const confirmed = confirm("Voulez-vous vraiment affecter ce dossier au groupe : « " + selectedOption + " » ?");

        if (confirmed) {
            form.submit();
        } else {
            // Réinitialise le select sur le placeholder
            select.selectedIndex = 0;
        }
    });
});
</script>



</body>
</html>